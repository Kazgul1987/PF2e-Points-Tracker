<section class="research-tracker">
  <header class="research-tracker__header">
    <h2>{{localize "PF2E.PointsTracker.Research.Title"}}</h2>
    <div class="research-tracker__actions">
      {{#if isGM}}
        <button type="button" data-action="import-topics">
          <i class="fas fa-file-import"></i>
          {{localize "PF2E.PointsTracker.Research.Import"}}
        </button>
        <button type="button" data-action="export-topics">
          <i class="fas fa-file-export"></i>
          {{localize "PF2E.PointsTracker.Research.Export"}}
        </button>
      {{/if}}
      <button type="button" class="research-tracker__create" data-action="create-topic">
        <i class="fas fa-plus"></i>
        {{localize "PF2E.PointsTracker.Research.CreateTopic"}}
      </button>
    </div>
  </header>

  {{#if topics.length}}
    <div class="research-tracker__topics">
      {{#each topics as |topic|}}
        <article class="research-topic" data-topic-id="{{topic.id}}">
          <header class="research-topic__header">
            <div>
              <h3 class="research-topic__name">{{topic.name}}</h3>
              <p class="research-topic__meta">
                {{localize "PF2E.PointsTracker.Research.TargetLabel" target=topic.target progress=topic.progress}}
                &bull;
                {{localize "PF2E.PointsTracker.Research.DifficultyLabel" difficulty=topic.difficulty}}
              </p>
            </div>
            <div class="research-topic__controls">
              <button type="button" data-action="add-points"><i class="fas fa-plus"></i></button>
              <button type="button" data-action="spend-points"><i class="fas fa-minus"></i></button>
              <button type="button" data-action="delete-topic"><i class="fas fa-trash"></i></button>
            </div>
          </header>
          <div class="research-topic__progress">
            <div class="research-topic__progress-bar" style="width: {{topic.progressPercent}}%"></div>
          </div>
          {{#if topic.summary}}
            <p class="research-topic__summary">{{topic.summary}}</p>
          {{/if}}
          {{#if topic.thresholds.length}}
            <section class="research-topic__thresholds">
              <header>
                <h4>{{localize "PF2E.PointsTracker.Research.Thresholds"}}</h4>
              </header>
              <ul>
                {{#each topic.thresholds as |threshold|}}
                  <li
                    class="research-threshold{{#if threshold.isUnlocked}} is-unlocked{{/if}}{{#if threshold.isRevealed}} is-revealed{{/if}}"
                  >
                    <div class="research-threshold__meta">
                      <span class="research-threshold__points">
                        {{localize "PF2E.PointsTracker.Research.ThresholdPoints" points=threshold.points}}
                      </span>
                      <span class="research-threshold__status">
                        {{#if threshold.isRevealed}}
                          {{localize "PF2E.PointsTracker.Research.ThresholdRevealed"}}
                        {{else if threshold.isUnlocked}}
                          {{localize "PF2E.PointsTracker.Research.ThresholdUnlocked"}}
                        {{else}}
                          {{localize "PF2E.PointsTracker.Research.ThresholdLocked"}}
                        {{/if}}
                      </span>
                    </div>
                    {{#if ../isGM}}
                      {{#if threshold.playerText}}
                        <div class="research-threshold__player-preview">
                          <strong>{{localize "PF2E.PointsTracker.Research.PlayerText"}}</strong>
                          {{{threshold.playerText}}}
                        </div>
                      {{/if}}
                      {{#if threshold.gmText}}
                        <div class="research-threshold__gm-text">
                          <strong>{{localize "PF2E.PointsTracker.Research.GMText"}}</strong>
                          {{{threshold.gmText}}}
                        </div>
                      {{/if}}
                      <div class="research-threshold__controls">
                        <button
                          type="button"
                          data-action="send-reveal"
                          data-threshold-id="{{threshold.id}}"
                          {{#unless threshold.isUnlocked}}disabled{{/unless}}
                          {{#if threshold.isRevealed}}disabled{{/if}}
                        >
                          {{localize "PF2E.PointsTracker.Research.RevealSend"}}
                        </button>
                        {{#if threshold.isRevealed}}
                          <button
                            type="button"
                            data-action="resend-reveal"
                            data-threshold-id="{{threshold.id}}"
                          >
                            {{localize "PF2E.PointsTracker.Research.RevealResend"}}
                          </button>
                        {{/if}}
                      </div>
                    {{else}}
                      {{#if threshold.isUnlocked}}
                        {{#if threshold.playerText}}
                          <div class="research-threshold__player-text">
                            {{{threshold.playerText}}}
                          </div>
                        {{/if}}
                      {{/if}}
                    {{/if}}
                  </li>
                {{/each}}
              </ul>
            </section>
          {{/if}}
          <section class="research-topic__participants">
            <header>
              <h4>{{localize "PF2E.PointsTracker.Research.Participants"}}</h4>
              <button type="button" data-action="add-participant">
                <i class="fas fa-user-plus"></i>
              </button>
            </header>
            {{#if topic.participants.length}}
              <ul>
                {{#each topic.participants as |participant|}}
                  <li data-participant-id="{{participant.id}}">
                    <div class="participant__info">
                      <strong>{{participant.name}}</strong>
                      {{#if participant.role}}
                        <span class="participant__role">{{participant.role}}</span>
                      {{/if}}
                      {{#if participant.skill}}
                        <span class="participant__skill">{{participant.skill}}</span>
                      {{/if}}
                    </div>
                    <div class="participant__controls">
                      <button type="button" data-action="perform-roll">
                        <i class="fas fa-dice-d20"></i>
                      </button>
                      <button type="button" data-action="remove-participant">
                        <i class="fas fa-user-minus"></i>
                      </button>
                    </div>
                  </li>
                {{/each}}
              </ul>
            {{else}}
              <p class="research-topic__no-participants">{{localize "PF2E.PointsTracker.Research.NoParticipants"}}</p>
            {{/if}}
          </section>
        </article>
      {{/each}}
    </div>
  {{else}}
    <p class="research-tracker__empty">{{localize "PF2E.PointsTracker.Research.NoTopics"}}</p>
  {{/if}}

  <section class="research-tracker__log">
    <header>
      <h3>{{localize "PF2E.PointsTracker.Research.Log"}}</h3>
    </header>
    {{#if log.length}}
      <ul>
        {{#each log as |entry|}}
          <li>
            <div class="log-entry__header">
              <time>{{entry.timestampFormatted}}</time>
              {{#if entry.actorName}}
                <span class="log-entry__actor">{{entry.actorName}}</span>
              {{/if}}
              {{#if entry.points}}
                <span class="log-entry__points">{{entry.points}}</span>
              {{/if}}
            </div>
            <p class="log-entry__message">{{entry.message}}</p>
            {{#if entry.rollSummary}}
              <p class="log-entry__roll">{{entry.rollSummary}}</p>
            {{/if}}
          </li>
        {{/each}}
      </ul>
    {{else}}
      <p class="research-tracker__no-log">{{localize "PF2E.PointsTracker.Research.NoLog"}}</p>
    {{/if}}
  </section>
</section>
