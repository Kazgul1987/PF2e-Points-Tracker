<section class="research-tracker">
  <header class="research-tracker__header">
    <h2>{{localize "PF2E.PointsTracker.Research.Title"}}</h2>
    <div class="research-tracker__actions">
      {{#if isGM}}
        <button type="button" data-action="import-topics">
          <i class="fas fa-file-import"></i>
          {{localize "PF2E.PointsTracker.Research.Import"}}
        </button>
        <button type="button" data-action="export-topics">
          <i class="fas fa-file-export"></i>
          {{localize "PF2E.PointsTracker.Research.Export"}}
        </button>
      {{/if}}
      {{#if isGM}}
        <button type="button" class="research-tracker__create" data-action="create-topic">
          <i class="fas fa-plus"></i>
          {{localize "PF2E.PointsTracker.Research.CreateTopic"}}
        </button>
      {{/if}}
    </div>
  </header>

  {{#if topics.length}}
    <div class="research-tracker__topics">
      {{#each topics as |topic|}}
        <article class="research-topic" data-topic-id="{{topic.id}}">
          <header class="research-topic__header">
            <div class="research-topic__title">
              <h3 class="research-topic__name">{{topic.name}}</h3>
              <div class="research-topic__meta">
                {{#if topic.skill}}
                  <span>{{localize "PF2E.PointsTracker.Research.SkillLabel" skill=topic.skill}}</span>
                {{/if}}
                {{#if topic.difficulty}}
                  <span>{{localize "PF2E.PointsTracker.Research.DifficultyLabel" difficulty=topic.difficulty}}</span>
                {{/if}}
              </div>
            </div>
            {{#if ../isGM}}
              <div class="research-topic__controls">
                <button type="button" data-action="add-points">
                  <i class="fas fa-plus"></i>
                </button>
                <button type="button" data-action="spend-points">
                  <i class="fas fa-minus"></i>
                </button>
                <button type="button" data-action="delete-topic">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            {{/if}}
          </header>

          <div class="research-topic__progress">
            <div class="research-topic__progress-track">
              <div class="research-topic__progress-bar" style="width: {{topic.progressPercent}}%"></div>
            </div>
            <div class="research-topic__progress-label">
              {{#if topic.locations.length}}
                {{localize "PF2E.PointsTracker.Research.ProgressLabel" collected=topic.progress target=topic.locationTotals.displayMax}}
              {{else}}
                {{localize "PF2E.PointsTracker.Research.ProgressLabel" collected=topic.progress target=topic.target}}
              {{/if}}
              {{#if topic.completed}}
                <span class="research-topic__badge">{{localize "PF2E.PointsTracker.Research.Completed"}}</span>
              {{/if}}
            </div>
          </div>

          <section class="research-topic__statblock">
            {{#if topic.summaryHtml}}
              <div class="research-topic__summary">{{{topic.summaryHtml}}}</div>
            {{/if}}
            <div class="research-topic__statblock-section">
              <h4>{{localize "PF2E.PointsTracker.Research.GatherInformation"}}</h4>
              {{#if topic.gatherInformationHtml}}
                <div class="research-topic__statblock-content">{{{topic.gatherInformationHtml}}}</div>
              {{else}}
                <p class="research-topic__empty">{{localize "PF2E.PointsTracker.Research.NoGatherInformation"}}</p>
              {{/if}}
            </div>
            <div class="research-topic__statblock-section">
              <h4>{{localize "PF2E.PointsTracker.Research.ResearchChecks"}}</h4>
              {{#if topic.researchChecksHtml}}
                <div class="research-topic__statblock-content">{{{topic.researchChecksHtml}}}</div>
              {{else}}
                <p class="research-topic__empty">{{localize "PF2E.PointsTracker.Research.NoResearchChecks"}}</p>
              {{/if}}
            </div>
          </section>

          <section class="research-topic__locations">
            <header class="research-topic__locations-header">
              <h4>{{localize "PF2E.PointsTracker.Research.LocationsHeading"}}</h4>
              <div class="research-topic__locations-actions">
                <span class="research-topic__locations-total">
                  {{localize "PF2E.PointsTracker.Research.LocationTotals" collected=topic.locationTotals.collected max=topic.locationTotals.displayMax}}
                </span>
                {{#if ../isGM}}
                  <button type="button" data-action="create-location">
                    <i class="fas fa-map-marker-alt"></i>
                    {{localize "PF2E.PointsTracker.Research.AddLocation"}}
                  </button>
                {{/if}}
              </div>
            </header>
            {{#if topic.locations.length}}
              <table class="research-topic__location-table">
                <thead>
                  <tr>
                    <th scope="col">{{localize "PF2E.PointsTracker.Research.LocationNameHeader"}}</th>
                    <th scope="col">{{localize "PF2E.PointsTracker.Research.LocationProgressHeader"}}</th>
                    {{#if ../isGM}}
                      <th scope="col" class="research-topic__location-actions-header">{{localize "PF2E.PointsTracker.Research.Actions"}}</th>
                    {{/if}}
                  </tr>
                </thead>
                <tbody>
                  {{#each topic.locations as |location|}}
                    <tr class="research-location" data-location-id="{{location.id}}">
                      <th scope="row">
                        <span class="research-location__name">{{location.name}}</span>
                      </th>
                      <td>
                        <div class="research-location__progress">
                          <div class="research-location__progress-track">
                            <div class="research-location__progress-bar" style="width: {{location.percent}}%"></div>
                          </div>
                          <div class="research-location__progress-label">
                            {{localize "PF2E.PointsTracker.Research.LocationProgress" collected=location.collected max=location.displayMax}}
                          </div>
                        </div>
                      </td>
                      {{#if ../isGM}}
                        <td class="research-location__actions">
                          <button type="button" data-action="add-points" data-location-id="{{location.id}}">
                            <i class="fas fa-plus"></i>
                          </button>
                          <button type="button" data-action="spend-points" data-location-id="{{location.id}}">
                            <i class="fas fa-minus"></i>
                          </button>
                          <button type="button" data-action="edit-location">
                            <i class="fas fa-edit"></i>
                          </button>
                          <button type="button" data-action="delete-location">
                            <i class="fas fa-trash"></i>
                          </button>
                        </td>
                      {{/if}}
                    </tr>
                  {{/each}}
                </tbody>
              </table>
            {{else}}
              <p class="research-topic__empty">{{localize "PF2E.PointsTracker.Research.NoLocations"}}</p>
            {{/if}}
          </section>

          {{#if topic.thresholds.length}}
            <section class="research-topic__thresholds">
              <header>
                <h4>{{localize "PF2E.PointsTracker.Research.Thresholds"}}</h4>
              </header>
              <ul>
                {{#each topic.thresholds as |threshold|}}
                  <li class="research-threshold{{#if threshold.isUnlocked}} is-unlocked{{/if}}{{#if threshold.isRevealed}} is-revealed{{/if}}">
                    <div class="research-threshold__meta">
                      <span class="research-threshold__points">
                        {{localize "PF2E.PointsTracker.Research.ThresholdPoints" points=threshold.points}}
                      </span>
                      <span class="research-threshold__status">
                        {{#if threshold.isRevealed}}
                          {{localize "PF2E.PointsTracker.Research.ThresholdRevealed"}}
                        {{else if threshold.isUnlocked}}
                          {{localize "PF2E.PointsTracker.Research.ThresholdUnlocked"}}
                        {{else}}
                          {{localize "PF2E.PointsTracker.Research.ThresholdLocked"}}
                        {{/if}}
                      </span>
                    </div>
                    {{#if ../isGM}}
                      {{#if threshold.playerText}}
                        <div class="research-threshold__player-preview">
                          <strong>{{localize "PF2E.PointsTracker.Research.PlayerText"}}</strong>
                          {{{threshold.playerText}}}
                        </div>
                      {{/if}}
                      {{#if threshold.gmText}}
                        <div class="research-threshold__gm-text">
                          <strong>{{localize "PF2E.PointsTracker.Research.GMText"}}</strong>
                          {{{threshold.gmText}}}
                        </div>
                      {{/if}}
                      <div class="research-threshold__controls">
                        <button
                          type="button"
                          data-action="send-reveal"
                          data-threshold-id="{{threshold.id}}"
                          {{#unless threshold.isUnlocked}}disabled{{/unless}}
                          {{#if threshold.isRevealed}}disabled{{/if}}
                        >
                          {{localize "PF2E.PointsTracker.Research.RevealSend"}}
                        </button>
                        {{#if threshold.isRevealed}}
                          <button
                            type="button"
                            data-action="resend-reveal"
                            data-threshold-id="{{threshold.id}}"
                          >
                            {{localize "PF2E.PointsTracker.Research.RevealResend"}}
                          </button>
                        {{/if}}
                      </div>
                    {{else}}
                      {{#if threshold.isUnlocked}}
                        {{#if threshold.playerText}}
                          <div class="research-threshold__player-text">
                            {{{threshold.playerText}}}
                          </div>
                        {{/if}}
                      {{/if}}
                    {{/if}}
                  </li>
                {{/each}}
              </ul>
            </section>
          {{/if}}

          <section class="research-topic__participants">
            <header>
              <h4>{{localize "PF2E.PointsTracker.Research.Participants"}}</h4>
              {{#if ../isGM}}
                <button type="button" data-action="add-participant">
                  <i class="fas fa-user-plus"></i>
                </button>
              {{/if}}
            </header>
            {{#if topic.participants.length}}
              <ul>
                {{#each topic.participants as |participant|}}
                  <li data-participant-id="{{participant.id}}">
                    <div class="participant__info">
                      <strong>{{participant.name}}</strong>
                      {{#if participant.role}}
                        <span class="participant__role">{{participant.role}}</span>
                      {{/if}}
                      {{#if participant.skill}}
                        <span class="participant__skill">{{participant.skill}}</span>
                      {{/if}}
                    </div>
                    <div class="participant__controls">
                      <button type="button" data-action="perform-roll">
                        <i class="fas fa-dice-d20"></i>
                      </button>
                      {{#if ../isGM}}
                        <button type="button" data-action="remove-participant">
                          <i class="fas fa-user-minus"></i>
                        </button>
                      {{/if}}
                    </div>
                  </li>
                {{/each}}
              </ul>
            {{else}}
              <p class="research-topic__empty">{{localize "PF2E.PointsTracker.Research.NoParticipants"}}</p>
            {{/if}}
          </section>
        </article>
      {{/each}}
    </div>
  {{else}}
    <p class="research-tracker__empty">{{localize "PF2E.PointsTracker.Research.NoTopics"}}</p>
  {{/if}}

  <section class="research-tracker__log">
    <header>
      <h3>{{localize "PF2E.PointsTracker.Research.Log"}}</h3>
    </header>
    {{#if log.length}}
      <ul>
        {{#each log as |entry|}}
          <li>
            <div class="log-entry__header">
              <time>{{entry.timestampFormatted}}</time>
              {{#if entry.actorName}}
                <span class="log-entry__actor">{{entry.actorName}}</span>
              {{/if}}
              {{#if entry.points}}
                <span class="log-entry__points">{{entry.points}}</span>
              {{/if}}
            </div>
            <p class="log-entry__message">{{entry.message}}</p>
            {{#if entry.rollSummary}}
              <p class="log-entry__roll">{{entry.rollSummary}}</p>
            {{/if}}
          </li>
        {{/each}}
      </ul>
    {{else}}
      <p class="research-tracker__no-log">{{localize "PF2E.PointsTracker.Research.NoLog"}}</p>
    {{/if}}
  </section>
</section>
